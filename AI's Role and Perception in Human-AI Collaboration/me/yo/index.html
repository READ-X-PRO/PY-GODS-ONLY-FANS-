<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medieval FPS - Advanced Operations</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: #181824;
            font-family: 'Segoe UI', Arial, sans-serif;
            color: white;
        }
        canvas {
            width: 100vw;
            height: 100vh;
            display: block;
        }
        /* Start Menu Overlay */
        #start-menu {
            position: fixed;
            top: 0; left: 0; width: 100vw; height: 100vh;
            background: linear-gradient(135deg, #181824 80%, #4A0072 100%);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 20000;
        }
        #start-menu h1 {
            font-size: 2.8em;
            color: #FFC107;
            margin-bottom: 10px;
            text-shadow: 0 4px 24px #000a;
        }
        #start-menu .subtitle {
            color: #a84cff;
            font-size: 1.2em;
            margin-bottom: 30px;
        }
        #start-menu .menu-btn {
            padding: 16px 40px;
            margin: 10px 0;
            font-size: 1.2em;
            border: none;
            border-radius: 8px;
            background: #4A0072;
            color: #fff;
            cursor: pointer;
            transition: background 0.2s, transform 0.1s;
            box-shadow: 0 2px 10px #0006;
            font-weight: bold;
        }
        #start-menu .menu-btn:hover {
            background: #a84cff;
            color: #fff;
            transform: scale(1.05);
        }
        #start-menu .menu-footer {
            margin-top: 40px;
            color: #ccc;
            font-size: 0.95em;
            opacity: 0.7;
        }
        /* Settings & Help Modal */
        .modal {
            display: none;
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: #23223a;
            color: #fff;
            padding: 30px 40px;
            border-radius: 12px;
            box-shadow: 0 8px 40px #000b;
            z-index: 21000;
            min-width: 320px;
            max-width: 90vw;
        }
        .modal h2 { margin-top: 0; color: #FFC107; }
        .modal button {
            margin-top: 20px;
            padding: 10px 24px;
            border: none;
            border-radius: 6px;
            background: #4A0072;
            color: #fff;
            cursor: pointer;
            font-size: 1em;
        }
        .modal button:hover { background: #a84cff; }
        /* Inventory */
        .inventory {
            position: fixed; top: 10px; left: 10px;
            background: rgba(30,30,40,0.85); color: #fff;
            padding: 14px 18px; border-radius: 10px;
            box-shadow: 0 2px 12px #0008;
            font-family: 'Segoe UI', Arial, sans-serif;
            display: none;
        }
        .inventory h3 { margin: 0 0 8px 0; font-size: 1.1em; }
        .inventory ul { margin: 0; padding: 0 0 0 18px; }
        #battle {
            position: fixed; bottom: 20px; left: 50%;
            transform: translateX(-50%);
            background: linear-gradient(90deg, #2d0036 60%, #3a1c4a 100%);
            color: #fff; padding: 22px 32px; border-radius: 16px;
            font-family: 'Segoe UI', Arial, sans-serif;
            box-shadow: 0 4px 24px #000a;
            z-index: 1000; min-width: 320px;
            text-align: center;
            border: 2px solid #a84cff;
        }
        #battle button {
            margin: 10px 8px 0 8px; padding: 8px 18px;
            background: #a84cff; color: #fff; border: none;
            border-radius: 6px; font-size: 1em; cursor: pointer;
            transition: background 0.2s;
        }
        #battle button:hover { background: #d1aaff; color: #2d0036; }
        #party {
            position: fixed; top: 90px; left: 20px;
            color: #fff; background: rgba(30,30,40,0.85);
            padding: 12px 18px; border-radius: 10px;
            font-family: 'Segoe UI', Arial, sans-serif;
            box-shadow: 0 2px 12px #0008;
        }
        #party span { display: inline-block; margin-bottom: 4px; }
        #party span[style*="cursor:pointer"] { text-decoration: underline; }
        #info {
            position: fixed; top: 10px; right: 10px;
            background: rgba(30,30,40,0.92); color: #fff;
            padding: 14px 18px; border-radius: 10px;
            max-width: 340px; font-family: 'Segoe UI', Arial, sans-serif;
            box-shadow: 0 2px 12px #0008;
        }
    </style>
</head>
<body>
    <!-- Start Menu Overlay -->
    <div id="start-menu">
        <h1>Medieval FPS</h1>
        <div class="subtitle">Advanced Operations</div>
        <button class="menu-btn" id="btn-newgame">New Game</button>
        <button class="menu-btn" id="btn-continue">Continue</button>
        <button class="menu-btn" id="btn-settings">Settings</button>
        <button class="menu-btn" id="btn-help">Help</button>
        <div class="menu-footer">© 2025 Daniel Studios. Press <b>F5</b> to Save, <b>F9</b> to Load.</div>
    </div>
    <!-- Settings Modal -->
    <div class="modal" id="settings-modal">
        <h2>Settings</h2>
        <label>
            <span>Music Volume:</span>
            <input type="range" min="0" max="1" step="0.01" id="music-volume" value="0.5">
        </label>
        <br><br>
        <label>
            <span>Graphics Quality:</span>
            <select id="graphics-quality">
                <option value="high">High</option>
                <option value="medium">Medium</option>
                <option value="low">Low</option>
            </select>
        </label>
        <br>
        <button onclick="closeSettings()">Close</button>
    </div>
    <!-- Help Modal -->
    <div class="modal" id="help-modal">
        <h2>Help & Controls</h2>
        <ul>
            <li><b>WASD</b> or <b>Arrow Keys</b>: Move</li>
            <li><b>Space</b>: Jump</li>
            <li><b>1-4</b>: Switch Actions</li>
            <li><b>I</b>: Inventory</li>
            <li><b>Q</b>: Quest Log</li>
            <li><b>Click</b>: Interact</li>
            <li><b>F5</b>: Save &nbsp; <b>F9</b>: Load</li>
        </ul>
        <button onclick="closeHelp()">Close</button>
    </div>
    <div class="inventory">
        <h3>Inventory</h3>
        <ul id="inventory-list"></ul>
    </div>
    <script type="module">
        // --- Start Menu Logic ---
        let gameStarted = false;
        let animationPaused = true;
        const startMenu = document.getElementById('start-menu');
        const settingsModal = document.getElementById('settings-modal');
        const helpModal = document.getElementById('help-modal');
        document.getElementById('btn-newgame').onclick = () => {
            startMenu.style.display = 'none';
            animationPaused = false;
            if (!gameStarted) { initGame(); gameStarted = true; }
        };
        document.getElementById('btn-continue').onclick = () => {
            startMenu.style.display = 'none';
            animationPaused = false;
            if (!gameStarted) { initGame(); gameStarted = true; }
            setTimeout(() => loadGame(), 500);
        };
        document.getElementById('btn-settings').onclick = () => { settingsModal.style.display = 'block'; };
        document.getElementById('btn-help').onclick = () => { helpModal.style.display = 'block'; };
        window.closeSettings = () => { settingsModal.style.display = 'none'; };
        window.closeHelp = () => { helpModal.style.display = 'none'; };
        function showMenu() {
            startMenu.style.display = 'flex';
            animationPaused = true;
        }
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                if (startMenu.style.display === 'none') showMenu();
                else startMenu.style.display = 'none', animationPaused = false;
            }
        });

        // === Basic Setup ===
        let renderer, scene, camera, ambientLight, directionalLight, ground, player, vampire;
        let animateId;
        function initGame() {
            // Prevent double init
            if (renderer) return;
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.body.appendChild(renderer.domElement);

            // Lighting
            ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
            scene.add(ambientLight);
            directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 20, 0);
            scene.add(directionalLight);

            // Ground
            const groundGeometry = new THREE.PlaneGeometry(50, 50);
            const groundMaterial = new THREE.MeshPhongMaterial({ color: 0x888888 });
            ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            scene.add(ground);

            // Player
            const playerGeometry = new THREE.BoxGeometry(1, 2, 1);
            const playerMaterial = new THREE.MeshPhongMaterial({ color: 0x00ff00 });
            player = new THREE.Mesh(playerGeometry, playerMaterial);
            player.position.set(0, 1, 0);
            scene.add(player);

            // Enemy (Vampire)
            const vampireGeometry = new THREE.BoxGeometry(1, 2, 1);
            const vampireMaterial = new THREE.MeshPhongMaterial({ color: 0x880088 });
            vampire = new THREE.Mesh(vampireGeometry, vampireMaterial);
            vampire.position.set(5, 1, 5);
            scene.add(vampire);

            // Interactivity
            renderer.domElement.addEventListener('pointerdown', (event) => {
                const mouse = new THREE.Vector2(
                    (event.clientX / window.innerWidth) * 2 - 1,
                    -(event.clientY / window.innerHeight) * 2 + 1
                );
                const raycaster = new THREE.Raycaster();
                raycaster.setFromCamera(mouse, camera);

                const interactables = [vampire];
                const intersects = raycaster.intersectObjects(interactables);

                if (intersects.length > 0) {
                    const obj = intersects[0].object;
                    if (obj === vampire && vampireStats.isAlive) {
                        showBattleUI();
                    }
                }
            });

            renderer.domElement.addEventListener('pointermove', (event) => {
                const mouse = new THREE.Vector2(
                    (event.clientX / window.innerWidth) * 2 - 1,
                    -(event.clientY / window.innerHeight) * 2 + 1
                );
                const raycaster = new THREE.Raycaster();
                raycaster.setFromCamera(mouse, camera);
                const interactables = [vampire];
                const intersects = raycaster.intersectObjects(interactables);
                document.body.style.cursor = intersects.length > 0 ? 'pointer' : '';
            });

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
            });

            showPartyHUD();
            showStoryChapter(currentChapter);
            updateInventoryUI();
            animate();
        }

        // === RPG Webtoon Storyline & Characters ===
        const storyline = [
            { chapter: 1,  title: "Prologue: The Prophecy", description: "The legend of the Chosen One is revealed." },
            { chapter: 2,  title: "A Village in Peril", description: "The hero’s hometown is attacked by shadow beasts." },
            { chapter: 3,  title: "First Steps", description: "Tutorial: basic movement, combat, and inventory." },
            { chapter: 4,  title: "The Lost Heirloom", description: "Retrieve a family relic from goblin caves." },
            { chapter: 5,  title: "Meeting the Mentor", description: "Guided by a mysterious mage." },
            { chapter: 6,  title: "Forest of Whispers", description: "Learn stealth and magic basics." },
            { chapter: 7,  title: "Bandit Ambush", description: "First boss fight; rescue a merchant." },
            { chapter: 8,  title: "The Ancient Ruins", description: "Solve puzzles to unlock hidden powers." },
            { chapter: 9,  title: "A Friend in Need", description: "Recruit the first party member." },
            { chapter: 10, title: "Departure", description: "Leave the village, beginning the true journey." },
            { chapter: 100, title: "Bonus: The Next Adventure", description: "Tease a sequel or spin-off." }
        ];
        for (let i = 11; i <= 99; i++) {
            storyline.splice(i-1, 0, { chapter: i, title: `Chapter ${i}`, description: `Story event for chapter ${i}.` });
        }

        const characters = [
            { name: "Alden", role: "Hero", description: "The chosen one destined to save Eldoria." },
            { name: "Lyra", role: "Mage Mentor", description: "A wise mage who guides the hero." },
            { name: "Garrick", role: "Warrior Companion", description: "A loyal friend and skilled swordsman." },
            { name: "Selene", role: "Rogue", description: "A stealthy thief with a mysterious past." },
            { name: "Vampire Lord", role: "Antagonist", description: "A powerful foe who commands the shadows." }
        ];

        let currentChapter = 1;
        function showStoryChapter(chapterNum) {
            const chapter = storyline.find(c => c.chapter === chapterNum);
            if (!chapter) return;
            let infoDiv = document.getElementById('info');
            if (!infoDiv) {
                infoDiv = document.createElement('div');
                infoDiv.id = 'info';
                document.body.appendChild(infoDiv);
            }
            infoDiv.innerHTML = `<h2>Chapter ${chapter.chapter}: ${chapter.title}</h2><p>${chapter.description}</p>`;
        }

        let party = [characters[0], characters[2]]; // Alden and Garrick

        function addToParty(characterName) {
            const char = characters.find(c => c.name === characterName);
            if (char && !party.includes(char)) {
                party.push(char);
                showPartyHUD();
            }
        }

        function showPartyHUD() {
            let partyDiv = document.getElementById('party');
            if (!partyDiv) {
                partyDiv = document.createElement('div');
                partyDiv.id = 'party';
                document.body.appendChild(partyDiv);
            }
            partyDiv.innerHTML = `<b>Party:</b><br>` + party.map((c, i) =>
                `<span style="cursor:pointer;color:${i === 0 ? '#ffd700' : '#fff'}" onclick="switchActiveCharacter(${i})">${c.name}</span><br>`
            ).join('');
        }
        window.switchActiveCharacter = function(idx) {
            if (idx > 0 && idx < party.length) {
                const temp = party[0];
                party[0] = party[idx];
                party[idx] = temp;
                showPartyHUD();
                showStoryChapter(currentChapter);
            }
        };

        // === Inventory System ===
        const inventory = [];
        function updateInventoryUI() {
            const list = document.getElementById('inventory-list');
            if (!list) return;
            list.innerHTML = '';
            inventory.forEach(item => {
                const li = document.createElement('li');
                li.textContent = item.name || item.type;
                list.appendChild(li);
            });
        }
        function addItemToInventory(item) {
            inventory.push(item);
            updateInventoryUI();
        }
        // Sample Items
        addItemToInventory({ name: 'Steel Sword', type: 'weapon', damage: 35 });
        addItemToInventory({ name: 'Health Potion', type: 'consumable', effect: 'heal' });

        // === Battle & Physics Variables ===
        let velocityY = 0;
        const gravity = -0.01;
        let isOnGround = true;

        let playerStats = {
            hp: 100,
            maxHp: 100,
            attack: 35,
            defense: 10
        };

        let vampireStats = {
            hp: 80,
            maxHp: 80,
            attack: 20,
            defense: 5,
            isAlive: true
        };

        // === Battle UI ===
        function showBattleUI() {
            let battleDiv = document.getElementById('battle');
            if (!battleDiv) {
                battleDiv = document.createElement('div');
                battleDiv.id = 'battle';
                document.body.appendChild(battleDiv);
            }
            battleDiv.innerHTML = `
                <b>Battle!</b><br>
                <span>Player HP: ${playerStats.hp}/${playerStats.maxHp}</span> |
                <span>Vampire HP: ${vampireStats.hp}/${vampireStats.maxHp}</span><br>
                <button onclick="playerAttack()">Attack</button>
                <button onclick="playerUsePotion()">Use Potion</button>
                <button onclick="endBattle()">Run</button>
            `;
            battleDiv.style.display = 'block';
        }
        window.showBattleUI = showBattleUI;

        function hideBattleUI() {
            const battleDiv = document.getElementById('battle');
            if (battleDiv) battleDiv.style.display = 'none';
        }
        window.hideBattleUI = hideBattleUI;

        // === Battle Logic ===
        window.playerAttack = function() {
            if (!vampireStats.isAlive) return;
            let dmg = Math.max(0, playerStats.attack - vampireStats.defense + Math.floor(Math.random()*6-3));
            vampireStats.hp -= dmg;
            vampire.material.color.set(0xff0000);
            setTimeout(() => vampire.material.color.set(0x880088), 200);
            showBattleUI();
            if (vampireStats.hp <= 0) {
                vampireStats.isAlive = false;
                vampire.visible = false;
                hideBattleUI();
                alert("You defeated the Vampire Lord!");
                addToParty("Vampire Lord");
                return;
            }
            setTimeout(enemyAttack, 500);
        };

        window.playerUsePotion = function() {
            const potionIdx = inventory.findIndex(i => i.type === 'consumable' && i.effect === 'heal');
            if (potionIdx !== -1) {
                playerStats.hp = Math.min(playerStats.maxHp, playerStats.hp + 40);
                inventory.splice(potionIdx, 1);
                updateInventoryUI();
                showBattleUI();
                setTimeout(enemyAttack, 500);
            } else {
                alert("No potions left!");
            }
        };

        function enemyAttack() {
            if (!vampireStats.isAlive) return;
            let dmg = Math.max(0, vampireStats.attack - playerStats.defense + Math.floor(Math.random()*6-3));
            playerStats.hp -= dmg;
            player.material.color.set(0xff0000);
            setTimeout(() => player.material.color.set(0x00ff00), 200);
            showBattleUI();
            if (playerStats.hp <= 0) {
                hideBattleUI();
                alert("You were defeated! Reload to try again.");
            }
        }

        window.endBattle = function() {
            hideBattleUI();
            player.position.x -= 2;
            player.position.z -= 2;
        };

        // === Movement Controls ===
        const moveSpeed = 0.2;
        const keys = {};
        document.addEventListener('keydown', (e) => {
            keys[e.key.toLowerCase()] = true;
            if (e.key === ' ') {
                if (isOnGround) {
                    velocityY = 0.25;
                    isOnGround = false;
                }
            }
            // Inventory, party, chapter, recruit shortcuts
            if (e.key === 'i') { // Toggle inventory
                const inv = document.querySelector('.inventory');
                inv.style.display = inv.style.display === 'block' ? 'none' : 'block';
            }
            if (e.key === 'c') { // Show/hide party HUD
                const partyDiv = document.getElementById('party');
                if (partyDiv) partyDiv.style.display = partyDiv.style.display === 'none' ? 'block' : 'none';
            }
            if (e.key === 'n') { // Next chapter
                currentChapter = Math.min(currentChapter + 1, storyline.length);
                showStoryChapter(currentChapter);
            }
            if (e.key === 'p') { // Add Lyra to party
                addToParty("Lyra");
            }
        });
        document.addEventListener('keyup', (e) => { keys[e.key.toLowerCase()] = false; });

        // === Animation Loop with Pause Support ===
        function animate() {
            if (animationPaused) {
                animateId = requestAnimationFrame(animate);
                return;
            }
            animateId = requestAnimationFrame(animate);

            let moved = false;
            if (keys['w']) { player.position.z -= moveSpeed; moved = true; }
            if (keys['s']) { player.position.z += moveSpeed; moved = true; }
            if (keys['a']) { player.position.x -= moveSpeed; moved = true; }
            if (keys['d']) { player.position.x += moveSpeed; moved = true; }

            // Gravity and jumping
            if (!isOnGround) {
                velocityY += gravity;
                player.position.y += velocityY;
                if (player.position.y <= 1) {
                    player.position.y = 1;
                    velocityY = 0;
                    isOnGround = true;
                }
            }

            // Simple collision: prevent walking through vampire
            if (vampireStats.isAlive) {
                const dx = player.position.x - vampire.position.x;
                const dz = player.position.z - vampire.position.z;
                const dist = Math.sqrt(dx*dx + dz*dz);
                if (dist < 1.5) {
                    // Knockback effect
                    const angle = Math.atan2(dz, dx);
                    player.position.x += Math.cos(angle) * 0.1;
                    player.position.z += Math.sin(angle) * 0.1;
                }
            }

            camera.position.set(player.position.x, player.position.y + 5, player.position.z + 8);
            camera.lookAt(player.position.x, player.position.y + 1, player.position.z);

            renderer.render(scene, camera);
        }

        // Dummy loadGame for continue button
        function loadGame() {
            alert("Load game feature coming soon!");
        }

        // Show initial story and party HUD
        showPartyHUD();
        showStoryChapter(currentChapter);
        updateInventoryUI();
    </script>
</body>
</html>